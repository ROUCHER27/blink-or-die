## 问题诊断
- 页面已与扩展握手成功，但点击“开始检测”后未看到摄像头调用，最大概率是：
  - Offscreen 文档刚创建时尚未完成初始化，后台立即发送 `START_DETECTION` 被丢失（竞态）
  - Offscreen 的权限/错误提示发生在不可见文档中，`alert` 不可见，用户以为没有调用
  - 权限或系统层阻塞导致 `getUserMedia` 失败，但错误没有回传到页面

## 改造目标
- 保证 Offscreen 初始化就绪后再启动检测（消除竞态）
- 将检测状态与错误通过扩展→内容脚本→页面的管道回传，页面能看到真实启动/错误信息
- 保持现有测试页的“开始测试扩展”按钮，不进入模拟模式即可真实测试

## 技术方案
1. Offscreen 就绪握手
- 在 `offscreen/offscreen.js` 的 `init()` 完成后发送一次 `{type: 'OFFSCREEN_READY'}` 给后台
- 后台在 `background.js` 中维护 `offscreenReady` 标记，并在收到就绪后才下发 `START_DETECTION`

2. 稳定启动序列与重试
- `background.js` 的 `START_DETECTION` 处理：
  - 调用 `createOffscreenDocument()`；成功后等待 `offscreenReady === true`
  - 若 1 秒内未就绪，以 3 次退避重试发送 `START_DETECTION`，避免竞态丢消息

3. 错误与状态回传（去除不可见 alert）
- Offscreen 捕获的错误不 `alert`，改为发送 `{type: 'DETECTION_ERROR', payload: {name, message}}` 给后台
- 后台将错误广播到所有标签页；内容脚本转发为 `window.postMessage({source: 'blink-or-die', type: 'BOD_ERROR', payload})`
- 测试页监听 `BOD_ERROR`，在 UI 上显示明确原因（权限拒绝、设备占用、未找到摄像头等）

4. 启停与状态事件
- Offscreen 启动成功时发送 `{type: 'DETECTION_STARTED'}`；停止时发送 `{type: 'DETECTION_STOPPED'}`
- 后台广播；内容脚本转发为 `BOD_DETECTION_STARTED/STOPPED`，测试页据此设置 `isDetecting` 与倒计时
- 眨眼事件保持现有 `BLINK_DETECTED` → `BOD_BLINK_DETECTED` 路径

5. 页面配合
- `test.html` 已发送 `BOD_START_DETECTION`，继续监听新增的 `BOD_DETECTION_STARTED/STOPPED/BOD_ERROR` 并更新 UI
- 不再在页面级别强制摄像头预检失败时进入模拟模式，只在确实未握手成功时才提示模拟

## 验证步骤
- 在扩展管理页“重新加载”扩展；打开 `http://127.0.0.1:<端口>/test.html`
- 点击“开始测试扩展”，观察：
  - 背景日志出现 `Offscreen document created` 与 `OFFSCREEN_READY`
  - 随后 `DETECTION_STARTED` 广播到页面；若权限不足，会收到 `BOD_ERROR` 并显示具体原因
  - 眨眼时页面收到 `BOD_BLINK_DETECTED`，倒计时重置；超过 15 秒进入惩罚效果

## 风险与兼容
- 该改造不改变现有核心检测逻辑，仅加强通信与状态回传；对 MV3 与 macOS 隐私权限兼容良好
- 若系统层面阻止摄像头，页面将明确显示错误原因和修复路径，避免“看起来什么都没发生”